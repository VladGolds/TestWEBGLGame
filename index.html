<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Онлайн Кинотеатр</title>
    <link rel="stylesheet" href="style.css">
    <script type="module">
        // Импорт необходимых функций из Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAZqT98d7V8gpCeNma7Aos3u7ol5_wOug4",
            authDomain: "games-63197.firebaseapp.com",
            databaseURL: "https://games-63197-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "games-63197",
            storageBucket: "games-63197.appspot.com",
            messagingSenderId: "217470228668",
            appId: "1:217470228668:web:30844724050d278a7358b9"
        };

        // Инициализация Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const moviesRef = ref(database, 'movies');

        // Отправка текущей даты в базу данных
        function sendDate() {
            const today = new Date().toISOString().slice(0, 10);
            set(ref(database, 'dates/' + today), {
                date: today
            }).then(() => {
                console.log("Дата успешно отправлена в базу данных:", today);
            }).catch((error) => {
                console.error("Ошибка при отправке даты:", error);
            });
        }

        sendDate();

        // Проверка имени пользователя при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            const username = localStorage.getItem('username');
            const authButton = document.getElementById('auth-button');
            const adminButton = document.querySelector('.admin-button');
            const welcomeMessageContainer = document.querySelector('.auth-buttons');
            const welcomeMessage = document.getElementById('welcome-message');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const logoutButton = document.getElementById('logout-button');

            if (username) {
                authButton?.remove(); // Удаляем кнопку регистрации/входа
                const welcomeMessage = document.createElement('span');
                welcomeMessage.textContent = `Добро пожаловать, ${username}!`;
                welcomeMessage.classList.add('username-highlight');
                welcomeMessageContainer.appendChild(welcomeMessage); // Добавляем элемент с приветствием

                // Показ выпадающего меню при клике на приветственное сообщение
                welcomeMessage.addEventListener('click', () => {
                    dropdownMenu.classList.toggle('show');

                });

                // Обработчик клика на кнопку "Выход"
                logoutButton.addEventListener('click', () => {
                    localStorage.removeItem('username'); // Удаляем имя пользователя из localStorage
                    window.location.reload(); // Перезагружаем страницу
                });
                
                // Получаем информацию о пользователе из Firebase
                const userRef = ref(database, 'users/' + username);
                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();

                        // Проверяем роль пользователя
                        if (userData.role === 'admin') {
                            adminButton.style.display = 'block'; // Показываем кнопку для админов
                        } else {
                            adminButton.style.display = 'none'; // Скрываем кнопку для обычных пользователей
                        }
                    } else {
                        console.log('Пользователь не найден в базе данных.');
                        adminButton.style.display = 'none'; // Если пользователя нет, скрываем кнопку
                    }
                }).catch((error) => {
                    console.error("Ошибка получения данных: ", error);
                    adminButton.style.display = 'none'; // Если произошла ошибка, скрываем кнопку
                });
            } else {
                adminButton.style.display = 'none'; // Если пользователь не авторизован, скрываем кнопку
            }
            // Обработчик для навигации по категориям
            const currentPage = window.location.pathname.split('/').pop(); // Получаем имя текущей страницы
            const categories = document.querySelectorAll('.categories li a'); // Находим все ссылки в категории

            categories.forEach(category => {
                if (category.getAttribute('href') === currentPage) {
                    category.classList.add('active'); // Добавляем активный класс к текущей ссылке
                }
            });
        });

        document.getElementById('create-lobby').addEventListener('click', createLobby);
        document.getElementById('join-lobby').addEventListener('click', joinLobby);

        function createLobby() {
            const lobbyCode = Math.random().toString(36).substring(2, 8); // Генерация кода лобби
            const username = localStorage.getItem('username');

            // Создаем запись лобби в Firebase
            set(ref(database, 'lobbies/' + lobbyCode), {
                host: username,
                players: {
                    [username]: {
                        ready: false
                    }
                },
                gameMode: 'waiting',
                playerCount: 1
            }).then(() => {
                window.location.href = `lobby.html?lobbyCode=${lobbyCode}`; // Перенаправление в лобби
            }).catch((error) => {
                console.error("Ошибка создания лобби:", error);
            });
        }

        function joinLobby() {
            const lobbyCode = prompt("Введите код лобби:");
            const username = localStorage.getItem('username');

            // Проверка наличия лобби с введенным кодом
            const lobbyRef = ref(database, 'lobbies/' + lobbyCode);
            get(lobbyRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const lobbyData = snapshot.val();

                    // Добавление пользователя в лобби
                    set(ref(database, 'lobbies/' + lobbyCode + '/players/' + username), {
                        ready: false
                    }).then(() => {
                        window.location.href = `lobby.html?lobbyCode=${lobbyCode}`; // Перенаправление в лобби
                    });
                } else {
                    alert("Лобби с таким кодом не существует.");
                }
            }).catch((error) => {
                console.error("Ошибка при подключении к лобби:", error);
            });
        }
    </script>
</head>
<body>
    <header>
        <div class="auth-buttons">
            <a href="account.html" id="auth-button" class="auth-button">Регистрация / Вход</a>

            <div id="welcome-container" class="welcome-container">
                <span id="welcome-message"></span>
                <div id="dropdown-menu" class="dropdown-menu">
                    <button id="logout-button">Выход</button>
                </div>
            </div>
        </div>
        <h1>Test Films</h1>
    </header>

    <div class="container">
    <h1>Лобби</h1>

    <!-- Код для создания и присоединения к лобби -->
    <div class="lobby-container">
        <div class="lobby-actions">
            <button id="create-lobby">Создать Лобби</button>
            <input type="text" id="lobby-code" placeholder="Введите код лобби">
            <button id="join-lobby" class="join-button">Присоединиться</button>
        </div>
        <p class="lobby-code">Код лобби: <span id="lobby-code-display">12345</span></p>
    </div>
    
    <!-- Информация о хосте -->
    <div class="host-info">
        <p>Хост лобби: <span id="host-name">Player 1</span></p>
    </div>

    <!-- Таблица игроков -->
    <table class="players-table">
        <thead>
            <tr>
                <th>Имя игрока</th>
                <th>Статус готовности</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Player 1</td>
                <td class="ready">Готов</td>
            </tr>
            <tr>
                <td>Player 2</td>
                <td class="not-ready">Не готов</td>
            </tr>
        </tbody>
    </table>

    <!-- Выбор режима игры -->
    <div class="mode-selection">
        <label for="game-mode">Выберите режим:</label>
        <select id="game-mode">
            <option value="minigame1">Мини-игра 1</option>
            <option value="minigame2">Мини-игра 2</option>
        </select>
        <button id="start-game">Начать игру</button>
    </div>

    <!-- Кнопка для перехода на admin.html -->
    <div class="admin-button">
        <a href="admin.html">
            <button id="adminPanelButton">Админ панель</button>
        </a>
    </div>
</body>
</html>